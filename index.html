<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Homepage</title>
    <style>
      .timetables {
        margin-left: 20px;
      }
    </style>
  </head>
  <body>
    <!-- React will render its content inside this div -->
    <div id="root"></div>

    <!-- Load core React library from a CDN -->
    <!-- interface to create and manage React components -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>

    <!-- Load ReactDOM from a CDN -->
    <!-- render layer that renders React components into the DOM -->
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="data.js"></script>

    <script>
      function App() {
        const [LineID, setLineID] = React.useState("G");
        const [startStationName, setStartStationName] =
          React.useState(undefined);
        const [destStationName, setDestStationName] = React.useState(undefined);
        const [serviceTag, setServiceTag] = React.useState(undefined);

        const targetLineData = data.filter(
          (item) =>
            item.LineID === LineID &&
            (!startStationName ||
              item.StationName.Zh_tw === startStationName) &&
            (!destStationName ||
              item.DestinationStationName.Zh_tw === destStationName) &&
            (!serviceTag || item.ServiceDay.ServiceTag === serviceTag)
        );
        const startStationNameSet = [
          ...new Set(targetLineData.map((item) => item.StationName.Zh_tw)),
        ];
        const destinationStationNameSet = [
          ...new Set(
            targetLineData.map((item) => item.DestinationStationName.Zh_tw)
          ),
        ];
        const serviceTagSet = [
          ...new Set(targetLineData.map((item) => item.ServiceDay.ServiceTag)),
        ];

        return React.createElement(
          "div",
          null,
          React.createElement("span", null, "選擇路線："),
          React.createElement(
            Button,
            {
              onClick: () => setLineID("G"),
            },
            "松山新店線"
          ),
          React.createElement(
            Button,
            {
              onClick: () => setLineID("R"),
            },
            "淡水信義線"
          ),
          React.createElement(
            Button,
            {
              onClick: () => setLineID("B"),
            },
            "板南線"
          ),
          React.createElement("br", null),
          React.createElement("span", null, "選擇起站："),
          startStationNameSet.map((stationName) =>
            React.createElement(
              Button,
              {
                key: stationName,
                onClick: () => setStartStationName(stationName),
              },
              stationName
            )
          ),
          React.createElement("br", null),
          React.createElement("span", null, "選擇迄站："),
          destinationStationNameSet.map((stationName) =>
            React.createElement(
              Button,
              {
                key: stationName,
                onClick: () => setDestStationName(stationName),
              },
              stationName
            )
          ),
          React.createElement("br", null),
          React.createElement("span", null, "服務類別："),
          serviceTagSet.map((tag) =>
            React.createElement(
              Button,
              {
                key: tag,
                onClick: () => setServiceTag(tag),
              },
              tag
            )
          ),
          React.createElement("br", null),
          React.createElement(
            "button",
            {
              onClick: () => {
                setStartStationName(undefined);
                setDestStationName(undefined);
                setServiceTag(undefined);
              },
            },
            "清除篩選條件"
          ),
          targetLineData.map((stationTimeTable, index) =>
            React.createElement(StationTimeTable, {
              key: index,
              stationTimeTable: stationTimeTable,
            })
          )
        );
      }

      function Button({ onClick, children }) {
        return React.createElement("button", { onClick: onClick }, children);
      }

      function StationTimeTable({ stationTimeTable }) {
        const StationName = stationTimeTable.StationName.Zh_tw;
        const DestinationStationName =
          stationTimeTable.DestinationStationName.Zh_tw;

        return React.createElement(
          "div",
          null,
          React.createElement(
            "h1",
            null,
            `臺北捷運 ${StationName}站往${DestinationStationName}站時刻表`
          ),
          React.createElement(
            "ul",
            null,
            React.createElement(
              "li",
              null,
              `路線：${stationTimeTable.RouteID}`
            ),
            React.createElement("li", null, `起站：${StationName}`),
            React.createElement("li", null, `迄站：${DestinationStationName}`)
          ),
          React.createElement(TimetableSpan, {
            serviceTag: stationTimeTable.ServiceDay.ServiceTag,
            timetables: stationTimeTable.Timetables,
          })
        );
      }

      // group by hour
      function TimetableSpan({ serviceTag, timetables }) {
        const groupedByHour = timetables.reduce((acc, curr) => {
          const hour = Number(curr.ArrivalTime.split(":")[0]);
          if (!acc[hour]) {
            acc[hour] = [];
          }
          acc[hour].push(curr.ArrivalTime);
          return acc;
        }, {});

        return React.createElement(
          "div",
          null,
          React.createElement("h3", null, serviceTag),
          React.createElement(
            "div",
            { className: "timetables" },
            Object.entries(groupedByHour).map(([hour, times]) =>
              React.createElement(
                "p",
                { key: hour },
                times.map((time, index) => `${time} `)
              )
            )
          )
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(React.createElement(App));
    </script>
  </body>
</html>
